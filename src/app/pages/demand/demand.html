<p-fluid>
    <div class="card">
        <p class="font-semibold text-xl">Demand Request</p>
        <form [formGroup]="demandForm" (ngSubmit)="onSubmit()">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="flex flex-wrap gap-2 w-full" formGroupName="project">
                    <label for="p-code">Project Code</label>
                    <p-select [options]="PCodeList" formControlName="projectId" id="p-code" optionLabel="projectCode" optionValue="projectId" placeholder="Select Project Code"
                        [filter]="true" filterBy="projectCode" [showClear]="true" class="w-full md:w-56" (onChange)="selectedPCode($event.value)"/>
                </div>
                <div class="flex flex-wrap gap-2 w-full">
                    <label for="site-name">Site Name</label>
                    <input type="text" pInputText [value]="projectDetails?.siteName" id="site-name" [disabled]="true" />
                </div>
                <div class="flex flex-wrap gap-2 w-full">
                    <label for="cluster">Cluster</label>
                    <input type="text" pInputText [value]="projectDetails?.cluster?.clusterName" id="cluster" [disabled]="true" />
                </div>
                <div class="flex flex-wrap gap-2 w-full">
                    <label for="cluster-head">Cluster Head</label>
                    <input type="text" pInputText [value]="projectDetails?.clusterHead?.userName" id="cluster-head" [disabled]="true" />
                </div>
                <div class="flex flex-wrap gap-2 w-full">
                    <label for="site-incharge">Site Incharge</label>
                    <input type="text" pInputText [value]="projectDetails?.siteIncharge?.userName" id="site-incharge" [disabled]="true" />
                </div>
                <div class="flex flex-wrap gap-2 w-full">
                    <label for="department">Department</label>
                    <input type="text" pInputText [value]="projectDetails?.department?.departmentName" id="department" [disabled]="true" />
                </div>
                <div class="flex flex-wrap gap-2 w-full">
                    <label for="department-head">Department Head</label>
                    <input type="text" pInputText [value]="projectDetails?.departmentHead?.userName" id="department-head" [disabled]="true" />
                </div>
                <div class="flex flex-wrap gap-2 w-full" formGroupName="category">
                    <label for="category">Category</label>
                    <p-select [options]="categoryList" formControlName="categoryId" id="category" optionLabel="categoryName" optionValue="categoryId" 
                        placeholder="Select Category" [filter]="true" filterBy="categoryName" class="w-full md:w-56" />
                </div>
                <div class="flex flex-wrap gap-2 w-full">
                    <label for="requestedBy">Requested By</label>
                    <input pInputText type="text" [value]="requestedBy" [disabled]="true" class="w-full" />
                </div>
                <div class="flex flex-wrap gap-2 w-full">
                    <label for="lastname2">Add Demand</label>
                    <p-button icon="pi pi-plus" [rounded]="true" class="w-full" (onClick)="addSpnRow()" />
                </div>

                
            </div>
            <div class="mt-4">
                <div class="flex items-center justify-between mb-1">
                    <p class="font-semibold text-xl">Demand Details</p>
                </div>
                <p-table [value]="demandDetails.controls" formArrayName="demandDetails" 
                    showGridlines [rowHover]="true" [scrollable]="true" scrollHeight="400px" [tableStyle]="{'min-width': '90rem'}">
                    <ng-template #header>
                        <tr>
                            <th>Sl_No</th>
                            <th>SPN</th>
                            <th>SPN Description</th>
                            <th>Experience</th>
                            <th>Quantity</th>
                            <th>Planned Deployment Date</th>
                            <th>Planned Release Date</th>
                            @if (demandDetails.length > 1) {
                                <th>Actions</th>
                            }
                        </tr>
                    </ng-template>
                    <ng-template #body let-row let-rowIndex="rowIndex">
                        <tr [formGroupName]="rowIndex">
                            <td>{{ rowIndex + 1 }}</td>
                            <td formGroupName="spn">
                                <p-select [options]="spnInfoList" formControlName="spnId" optionLabel="spnCode" optionValue="spnId" 
                                    [filter]="true" filterBy="spnCode" [showClear]="true" 
                                    placeholder="Select SPN Code" appendTo="body" (onChange)="selectedSpnCode($event.value, rowIndex)" />
                            </td>
                            <td>
                                <p-select [options]="spnInfoList" formControlName="spnDescription" 
                                    optionValue="spnId" [filter]="true" filterBy="spnDescription" [showClear]="true" 
                                    placeholder="Select SPN Description" appendTo="body" (onChange)="selectedSpnDescription($event.value, rowIndex)">
                                    <ng-template #item let-item>
                                        {{ item.spnDescription }} - ({{ item.experience }})
                                    </ng-template>
                                    <ng-template #selectedItem let-item>
                                        {{ item.spnDescription }} - ({{ item.experience }})
                                    </ng-template>
                                </p-select>
                            </td>
                            <td>
                                <p-select [options]="spnInfoList" formControlName="experience" optionLabel="experience" 
                                    optionValue="spnId" [filter]="true" filterBy="experience" [showClear]="true"
                                    placeholder="Select Experience" appendTo="body" />
                            </td>
                            <td>
                                <input pInputText type="number" min="1" formControlName="quantity" />
                            </td>
                            <td>
                                <p-datepicker formControlName="plannedDeploymentDate" [minDate]="minDate" 
                                    placeholder="Select Date" appendTo="body" (onSelect)="selectedDeploymentDate($event)" />
                            </td>
                            <td>
                                <p-datepicker formControlName="plannedReleaseDate" [minDate]="releaseMinDate" placeholder="Select Date" appendTo="body" />
                            </td>
                            @if (demandDetails.length > 1) {
                                <td>
                                    <p-button icon="pi pi-trash" severity="danger" [rounded]="true" (onClick)="deleteSpnRow(rowIndex)" />
                                </td>
                            }
                        </tr>
                    </ng-template>
                </p-table>

                <div class="flex justify-center items-center gap-4 mt-6">
                    <button pButton pRipple type="submit" label="Submit" class="p-button-outlined" icon="pi pi-save"></button>
                    <button pButton pRipple label="Reset" class="p-button-outlined" icon="pi pi-times" severity="danger" (click)="demandForm.reset()"></button>
                </div>
            </div>
        </form>
    </div>
</p-fluid>

<p-toast />