<div class="card">
    <div class="flex items-baseline-last justify-between">
        <h5>Attendance</h5>
        <p-datepicker view="month" [(ngModel)]="date" dateFormat="mm/yy" [readonlyInput]="true" 
            placeholder="Pick a month" (onSelect)="fetchAttendanceList()" />
    </div>
    <div class="border border-[var(--p-content-border-color)] rounded-lg overflow-hidden">
        <p-table [value]="attendanceList" stripedRows [rowHover]="true" [paginator]="true" [first]="first" editMode="row"
            [rows]="pageSize" [lazy]="true" [rowsPerPageOptions]="[10, 20, 30]" [showCurrentPageReport]="true"
            [scrollable]="true" scrollHeight="500px" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries" 
            [totalRecords]="totalRecords" [tableStyle]="{'min-width': '130rem'}" (onPage)="pageChange($event)">
            <ng-template #header>
                <tr>
                    <th>SL NO</th>
                    <th>Employee Code</th>
                    <th>Employee Name</th>
                    <th>SPN Code</th>
                    <th>SPN Description</th>
                    <th>Experience</th>
                    <th>Project Code</th>
                    <th>Site Name</th>
                    <th>Cluster Name</th>
                    <th>Role</th>
                    <th>Joining Date</th>
                    <th>Last Working Date</th>
                    <th>Status</th>
                    <th>Total No. of Working Days</th>
                    <th>Present Days</th>
                    <th>Week Off</th>
                    <th>Paid Leave</th>
                    <th>Unpaid Leave</th>
                    <th>Actions</th>
                </tr>
            </ng-template>
            <ng-template #body let-attendance let-editing="editing" let-i="rowIndex">
                <tr [pEditableRow]="attendance">
                    <td>{{ i + 1 }}</td>
                    <td>{{ attendance.candidate?.employeeCode || '-' }}</td>
                    <td>{{ attendance.candidate?.candidateName || '-' }}</td>
                    <td>{{ attendance.employmentDetails?.spn?.spnCode || '-' }}</td>
                    <td>{{ attendance.employmentDetails?.spn?.spnDescription }}</td>
                    <td>{{ attendance.employmentDetails?.spn?.experience }}</td>
                    <td>{{ attendance.employmentDetails.project.projectCode || '-' }}</td>               
                    <td>{{ attendance.employmentDetails.project.siteName || '-' }}</td>               
                    <td>{{ attendance.employmentDetails.cluster.clusterName || '-' }}</td>               
                    <td>{{ attendance.employmentDetails.envisionRole.roleName || '-' }}</td>   
                    <td>{{ attendance.employmentDetails.joiningDate || '-' }}</td>
                    <td>{{ attendance.employmentDetails.lastWorkingDate || '-' }}</td>
                    <td>
                        <p-tag [value]="attendance.employmentDetails.employmentStatus" 
                        [severity]="getSeverity(attendance.employmentDetails.employmentStatus)" />
                    </td> 
                    <td #pEditableColumn>
                        <p-cellEditor>
                            <ng-template #input>
                                <p-inputnumber [(ngModel)]="attendance.totalWorkingDays" [useGrouping]="false" />
                            </ng-template>
                            <ng-template #output>
                                {{ attendance.totalWorkingDays }}
                            </ng-template>
                        </p-cellEditor>
                    </td>                          
                    <td #pEditableColumn>
                        <p-cellEditor>
                            <ng-template #input>
                                <p-inputnumber [(ngModel)]="attendance.presentDays" [useGrouping]="false" />
                            </ng-template>
                            <ng-template #output>
                                {{ attendance.presentDays }}
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td #pEditableColumn>
                        <p-cellEditor>
                            <ng-template #input>
                                <p-inputnumber [(ngModel)]="attendance.weekOff" [useGrouping]="false" />
                            </ng-template>
                            <ng-template #output>
                                {{ attendance.weekOff }}
                            </ng-template>
                        </p-cellEditor>
                    </td>                          
                    <td #pEditableColumn>
                        <p-cellEditor>
                            <ng-template #input>
                                <p-inputnumber [(ngModel)]="attendance.paidLeaves" [useGrouping]="false" />
                            </ng-template>
                            <ng-template #output>      
                                {{ attendance.paidLeaves }}
                            </ng-template>
                        </p-cellEditor>
                    </td>                   
                    <td #pEditableColumn>
                        <p-cellEditor>
                            <ng-template #input>
                                <p-inputnumber [(ngModel)]="attendance.absentDays" [useGrouping]="false" />
                            </ng-template>
                            <ng-template #output>
                                {{ attendance.absentDays }}
                            </ng-template>
                        </p-cellEditor>
                    </td>  
                    <td class="flex items-center justify-center gap-2">
                        @if (!editing) {
                            <button pButton pRipple type="button" icon="pi pi-pencil"
                                pInitEditableRow rounded severity="secondary"
                                [disabled]="isEditDisabled(attendance, date)"></button>
                        } @else {
                            <button pButton pRipple type="submit" icon="pi pi-check"
                                pSaveEditableRow rounded severity="primary" (click)="submitAttendanceForm(attendance)"
                                [disabled]="isEditDisabled(attendance, date)">
                            </button>
                            <button pButton pRipple type="button" icon="pi pi-times"
                                pCancelEditableRow rounded severity="danger"
                                [disabled]="isEditDisabled(attendance, date)"></button>
                        }
                    </td>     
                </tr>
            </ng-template>
            <ng-template #emptymessage>
                <tr>
                    <td colspan="100%" style="text-align: center; padding: 1rem 0; background-color: var(--surface-ground);">
                        No Records Found
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<p-toast />